---
title: "Reproducible Research: Peer Assessment 1"
output: 
  html_document:
    keep_md: true
---


## Loading and preprocessing the data
First, the packages that will be required for data analysis and plotting are 
loaded.
```{r packages}
library(dplyr)
library(ggplot2)
```

The data file must be present in the working directory.

Headers are desired, but the date field should not be interpreted as a 
categorical variable on reading, as it will be transformed in the next step.
```{r readData}
activity <- read.csv("activity.csv", stringsAsFactors = FALSE)
```


```{r asDate}
activity$date <- as.Date(activity$date, format = "%Y-%m-%d")
```


In the original file, interval labels are stored as integer representations, 
starting at zero and increasing by five until an hour marker is reached, when 
they jump to the next multiple of 100. This allows them to be read easily as a 
record of the time when the interval begins. To show this, they are converted to 
a string of the form hh:mm and added as an extra column to the data frame.
```{r convertIntervals}
int_times <- activity$interval
int_times <- formatC(int_times, width = 4, format = "d", flag = "0")

for (i in 1:length(int_times)) {
        xxxx <- substring(int_times[i], c(1,3),c(2,4))
        int_times[i] <- paste(xxxx[1],xxxx[2], sep =":")
}

activity <- cbind(activity, int_times)
```


## What is mean total number of steps taken per day?
To plot the histogram, the sum of steps per day is calculated. The histogram 
binwidth is calculated using the Freedman-Diaconis rule...

```{r histogramNoNA}
act_summ <- activity%>%
group_by(date) %>%
summarise(steps = sum(steps, na.rm = T))

bw <- with(act_summ, diff(range(steps)) / (2 * IQR(steps) / length(steps)^1/3))
ggplot() + geom_histogram(aes(act_summ$steps), binwidth = bw)
```

The daily mean is:

```{r dailyMean}
mean(act_summ$steps)
```

## What is the average daily activity pattern?

```{r meanPerDay}
act_int <- activity %>%
group_by(int_times) %>%
summarise(ave_steps = mean(steps, na.rm = T))
```


```{r plotDaily}
int_gg <- ggplot(act_int, aes(int_times, ave_steps, group=1)) + geom_line()
int_gg + scale_x_discrete(breaks = c("00:00", "06:00", "12:00", "18:00", "23:55"))
```


```{r maxInterval}
act_int[act_int$ave_steps == max(act_int$ave_steps),]
```


## Imputing missing values
Calculate the total number of NA values recorded for steps
```{r NAsum}
sum(is.na(activity$steps))
```

By analysing the total number of NAs per day we can see that whole days are 
missing, not individual values per day. (Each day contains 288 intervals.)
```{r missingValues}
act_days <- activity %>%
    group_by(date) %>%
    summarise(steps = sum(is.na(steps))) %>%
    mutate(day = weekdays(date))

act_days[act_days$steps != 0 & act_days$steps != 288 ,]
```

There is no obvious pattern to the days in which no measurements were made

```{r missingDays}
act_days[act_days$steps == 288,]
```

There is no indication of what may have caused the loss of data on these 
particular days, so the imputation strategy has to rely on data provided for 
the other days. The variation over different intervals through each day argues 
against using the daily mean as a gross over-estimate. An average for each 
interval would be a better substitute. The median was chosen as it is less 
influenced by outlying values.

```{r imputeValues}
int_meds <- tapply(activity$steps, activity$interval, median, na.rm=T)
activity_imputed <- cbind(activity,medians = rep(int_meds,61))
for(i in seq(along=activity_imputed$steps)) {
    if(is.na(activity_imputed$steps[i])) {
        activity_imputed$steps[i] <- activity_imputed$medians[i]
    }
}
```

```{r histogramImputed}
act_summ_imputed <- activity_imputed%>%
group_by(date) %>%
summarise(steps = sum(steps, na.rm = T))

#bw <- with(act_summ_imputed, diff(range(steps)) / (2 * IQR(steps) / length(steps)^1/3))
ggplot() + geom_histogram(aes(act_summ_imputed$steps), binwidth = bw)
```

## Are there differences in activity patterns between weekdays and weekends?


```{r dayType}
wkday <- c("Monday","Tuesday","Wednesday","Thursday","Friday")
act_panels <- mutate(activity_imputed, day_type = ifelse(weekdays(date) %in% wkday, "Weekday", "Weekend"))
act_panels$day_type <- as.factor(act_panels$day_type)
```

```{r panelPlot}
act_int_imp <- act_panels %>%
        group_by(int_times, day_type) %>%
        summarise(ave_steps = mean(steps))

act_gg <- ggplot(act_int_imp, aes(int_times, ave_steps, group=1))
act_gg + scale_x_discrete(breaks = (c("00:00", "06:00", "12:00",
        "18:00", "23:55"))) + facet_wrap(~day_type, nrow=2) + geom_line() 
```